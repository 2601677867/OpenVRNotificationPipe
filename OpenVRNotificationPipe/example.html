<html>
    <head>
        <title>OpenVRNotificationPipe Example Page</title>
	</head>
	<body onload="init();">
		<p><input id="title" type="text" size="32" name="title" maxlength=127 value="Overlay title"/></p>
		<p><textarea id="message" cols=32 rows=3 name="message">This is a test text.</textarea></p>
		<p><canvas id="mycanvas"></canvas></p>
		<p><input type="file" id="fileUpload" accept="image/*"/></p>
		<p>Custom notification: <input type="checkbox" id="custom"/></p>-->
	<p><button onclick="submit();">Send notification</button></p>
	<script>
		var title = document.querySelector('#title');
		var message = document.querySelector('#message');
		var image = document.querySelector('#image');
		var custom = document.querySelector('#custom');

		var upload = document.getElementById('fileUpload');
		var canvas = document.getElementById('mycanvas');
		var ctx = canvas.getContext('2d');
		ctx.canvas.width = 128;
		ctx.canvas.height = 128;

		upload.addEventListener('change', readImage);

		var params = getParams(window.location.href);
		var port  = (typeof params.port == "undefined") ? 8077 : params.port;
		var wsUri = "ws://localhost:"+port;
		var output, deviceId, input, inputAnalog, inputPose, requests, applicationInfo, playArea, properties;
		var websocket;
		var active = false, stop = false;

		function getParams(url) {
			var params = {};
			var parser = document.createElement('a');
			parser.href = url;
			var query = parser.search.substring(1);
			var vars = query.split('&');
			for (var i = 0; i < vars.length; i++) {
				var pair = vars[i].split('=');
				params[pair[0]] = decodeURIComponent(pair[1]);
			}
			return params;
		};
		
		function init()
		{
			/*
			output = document.getElementById("output");
			requests = document.getElementById("requests");
			deviceIds = document.getElementById("deviceIds");
			input = document.getElementById("input");
			inputAnalog = document.getElementById("inputAnalog");
			inputPose = document.getElementById("inputPose");
			applicationInfo = document.getElementById("applicationInfo");
			playArea = document.getElementById("playArea");
			properties = document.getElementById("properties");
			*/
			connectLoop();
		}

		function connectLoop() 
		{
			if(!active) {
				active = true;
				if(typeof websocket !== 'undefined') websocket.close();
				websocket = new WebSocket(wsUri);
				websocket.onopen = function(evt) { onOpen(evt) };
				websocket.onclose = function(evt) { onClose(evt) };
				websocket.onmessage = function(evt) { onMessage(evt) };
				websocket.onerror = function(evt) { onError(evt) };
			}
			setTimeout(connectLoop, 5000);
		}

		function onOpen(evt)
		{
			active = true;
			writeToScreen("CONNECTED: "+JSON.stringify(evt, null, 2));
		}
		function onClose(evt)
		{
			active = false;
			writeToScreen("DISCONNECTED: "+JSON.stringify(evt, null, 2));
		}
		function onMessage(evt)
		{
			var data = JSON.parse(evt.data);
			var text = JSON.stringify(data, null, 2);
			if(data == null) writeToScreen("Response: " + text);
			else {
				writeToScreen("Response: " + text);
			}
		}
		function onError(evt) {
			writeToScreen("ERROR: "+JSON.stringify(evt, null, 2));
		}

		function doSend(payload){
			var text = JSON.stringify(payload);
			writeToScreen("Sending: "+text);
			websocket.send(text);
		}
		function doBytes(data) {
			websocket.send(data);
		}

		function writeToScreen(message) {
			console.log(message);
		}

		function readImage() {
		    if ( this.files && this.files[0] ) {
		        var FR= new FileReader();
		        FR.onload = function(e) {
		           	var img = new Image();
		           	img.addEventListener("load", function() {
		           		// Clear
						ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
						// Scale and draw
						var x, y, w, h;
						if(img.width > img.height) {
							y = 0;
							h = ctx.canvas.height;
							w = img.width * (ctx.canvas.height / img.height);
							x = -(w-ctx.canvas.width)/2;
						} else {
							x = 0;
							w = ctx.canvas.width;
							h = img.height * (ctx.canvas.width / img.width);
							y = -(h-ctx.canvas.height)/2;
						}
		             	ctx.drawImage(img, x, y, w, h);
		           	});
		           	img.src = e.target.result;
		        };       
		        FR.readAsDataURL( this.files[0] );
		    }
		}

		function submit() {	
			// var imageData = ctx.getImageData(0, 0, 128, 128).data;
			// console.log("Sending image: "+imageData.length);
			// doBytes(imageData);
			var data = {
				custom: custom.checked,
				title: title.value,
				message: message.value,
				image: canvas.toDataURL().split(',')[1] // .replace('+', '-').replace('/', '_').replace('=', '') // Remove image spec
			};
			
			var urlEncodedData = "";
			var urlEncodedDataPairs = [];
			var name;
			for(name in data) {
				urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
			}
			urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

			doSend(data);
		}
	</script>
	</body>
</html>