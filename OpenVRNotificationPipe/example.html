<html>
    <head>
        <title>OpenVRNotificationPipe Example Page</title>
		<style>
			body {
				font-family: sans-serif;
			}
			#status {
				padding: .5em;
				background-color: gray;
				color: white;
				font-weight: bold;
			}
			input[type="number"] {
				width: 4em;
			}
		</style>
	</head>
	<body onload="init();">
		<p id="status">N/A</p>
		<h2>General</h2>
		<p>Canvas size: <input type="number" id="canvasWidth" value="128"> x <input type="number" id="canvasHeight" value="128"> <button onclick="updateCanvas();">Update</button></p>
		<p><canvas id="mycanvas"></canvas></p>
		<p><input type="file" id="fileUpload" accept="image/*"/></p>

		<h2>Standard Notification</h2>
		<p>Title: <input id="title" type="text" size="32" name="title" maxlength=127 value="Overlay title"/></p>
		<p>Message: <textarea id="message" cols=32 rows=3 name="message">This is a test text.</textarea></p>
		<p><button onclick="submit(false);">Send notification</button></p>
		
		<h2>Custom Notification</h2>

		<h3>Properties</h3>
		<p>Anchor to headset: <input type="checkbox" id="headset"/></p>
		<p>Duration (ms): <input type="number" id="duration" value="2000"/></p>
		<p>Width (m): <input type="number" id="width" value="1"/></p>
		<p>Distance (m): <input type="number" id="distance" value="2"/></p>
		<p>Pitch (deg): <input type="number" id="pitch" value="-30"/></p>
		
		<h3>Transition</h3>
		<p>Interpolation: <input type="number" id="interpolation" value="3"/></p>
		<p>Duration (ms): <input type="number" id="transitionDuration" value="500"/></p>
		<p>Ease out duration (ms): <input type="number" id="easeOutDuration" value="500"/></p>
		<p>Opacity (0-1): <input type="number" id="opacity" value="0"/></p>
		<p>Vertical distance (m): <input type="number" id="vertical" value="-0.5"/></p>
		<p><button onclick="submit(true);">Send notification</button></p>

	<script>
		// General
		var _status = document.querySelector('#status');
		var _canvasWidth = document.querySelector('#canvasWidth');
		var _canvasHeight = document.querySelector('#canvasHeight');
		var _canvas = document.querySelector('#mycanvas');
		var _ctx = _canvas.getContext('2d');
		_ctx.canvas.width = 128;
		_ctx.canvas.height = 128;
		var _upload = document.querySelector('#fileUpload');
		_upload.addEventListener('change', readImage);

		// Standard
		var _title = document.querySelector('#title');
		var _message = document.querySelector('#message');

		// Custom
		var _headset = document.querySelector('#headset');
		var _duration = document.querySelector('#duration');
		var _width = document.querySelector('#width');
		var _distance = document.querySelector('#distance');
		var _pitch = document.querySelector('#pitch');

		var _interpolation = document.querySelector('#interpolation');
		var _transitionDuration = document.querySelector('#transitionDuration');
		var _opacity = document.querySelector('#opacity');
		var _vertical = document.querySelector('#vertical');

		// Connection
		var _websocket;
		var _active = false, _stop = false;

		function getParams(url) {
			var params = {};
			var parser = document.createElement('a');
			parser.href = url;
			var query = parser.search.substring(1);
			var vars = query.split('&');
			for (var i = 0; i < vars.length; i++) {
				var pair = vars[i].split('=');
				params[pair[0]] = decodeURIComponent(pair[1]);
			}
			return params;
		};
		
		function init()
		{
			connectLoop();
		}

		function connectLoop() 
		{
			if(!_active) {
				var params = getParams(window.location.href);
				var port  = (typeof params.port == "undefined") ? 8077 : params.port;
				var wsUri = "ws://localhost:"+port;
				_active = true;
				if(typeof _websocket !== 'undefined') _websocket.close();
				try {
					_websocket = new WebSocket(wsUri);
					_websocket.onopen = function(evt) { onOpen(evt) };
					_websocket.onclose = function(evt) { onClose(evt) };
					_websocket.onmessage = function(evt) { onMessage(evt) };
					_websocket.onerror = function(evt) { onError(evt) };	
				} catch (error) {
					_status.innerHTML = `ERROR: ${error}`;
				}
			}
			setTimeout(connectLoop, 5000);
		}

		function onOpen(evt)
		{
			_active = true;
			_status.innerHTML = "CONNECTED";
		}
		function onClose(evt)
		{
			_active = false;
			_status.innerHTML = "DISCONNECTED";
		}
		function onMessage(evt)
		{
			/*
			var data = JSON.parse(evt.data);
			var text = JSON.stringify(data, null, 2);
			if(data == null) console.log("Response: " + text);
			else console.log("Response: " + text);
			*/
			console.log(evt.data);
		}
		function onError(evt) {
			_status.innerHTML = "ERROR: "+JSON.stringify(evt, null, 2);
		}

		function doSend(payload){
			var text = JSON.stringify(payload);
			_websocket.send(text);
		}
		function doBytes(data) {
			_websocket.send(data);
		}

		function updateCanvas() {
			_ctx.canvas.width = _canvasWidth.value;
			_ctx.canvas.height = _canvasHeight.value;
		}

		function readImage() {
		    if ( this.files && this.files[0] ) {
		        var FR = new FileReader();
		        FR.onload = function(e) {
		           	var img = new Image();
		           	img.addEventListener("load", function() {
		           		// Clear
						_ctx.clearRect(0, 0, _ctx.canvas.width, _ctx.canvas.height);
						// Scale and draw
						var x, y, w, h;
						if(img.width > img.height) {
							y = 0;
							h = _ctx.canvas.height;
							w = img.width * (_ctx.canvas.height / img.height);
							x = -(w-_ctx.canvas.width)/2;
						} else {
							x = 0;
							w = _ctx.canvas.width;
							h = img.height * (_ctx.canvas.width / img.width);
							y = -(h-_ctx.canvas.height)/2;
						}
		             	_ctx.drawImage(img, x, y, w, h);
		           	});
		           	img.src = e.target.result;
		        };       
		        FR.readAsDataURL( this.files[0] );
		    }
		}

		function submit(custom) {	
			var data = {
				custom: custom,
				image: _canvas.toDataURL().split(',')[1],
				
				// Standard
				title: _title.value,
				message: _message.value,

				// Custom
				properties: {
					headset: _headset.checked,
					duration: _duration.value,
					width: _width.value,
					distance: _distance.value,
					pitch: _pitch.value
				},
				transition: {
					interpolation: _interpolation.value,
					duration: _transitionDuration.value,
					opacity: _opacity.value,
					vertical: _vertical.value
				}
			};
			
			var urlEncodedData = "";
			var urlEncodedDataPairs = [];
			var name;
			for(name in data) {
				urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
			}
			urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

			doSend(data);
		}
	</script>
	</body>
</html>